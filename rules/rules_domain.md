# rules_domain.md - Gocha Rumble 3D ドメインルール

## 1. Three.js / WebGL ガイドライン

### 1.1 パフォーマンス最適化
> **「Gocha」感覚にとって重要**: 数千のユニットをレンダリングする必要がある。

- **インスタンシング**:
  - ユニット、投射物、繰り返し使用される環境オブジェクトには必ず `InstancedMesh` を使用する。
  - 各ユニットごとに `Mesh` を作成しないこと。

- **物理演算**:
  - 数千のユニットにはシンプルな半径ベースの衝突判定を使用する。
  - 必要でない限り、メインのユニット群には重い3D物理エンジン（Cannon.js / Rapier）を使用しない。
  - 「揺れる」感覚にはシンプルな「押し出し」ロジックを推奨する。

- **メモリ**:
  - シーンのアンマウント時にジオメトリとマテリアルを破棄する。

### 1.2 ブラウザでのデバッグ (MCP)
- **コンテキスト**: Canvas要素はDOMツールで検査するのが困難。
- **戦略**:
  - Three.jsの内部を確認するには `evaluate_script` を使用: `window.__r3f.canvas` または利用可能な場合は類似のフック。
  - フレームレート（FPS）とDraw Callをログに記録する。

## 2. ゲームロジック

### 2.1 バトルシステム
- **自動バトル**: ユニットは自動的に行動する。
- **状態**:
  - `Idle`: その場で跳ね回る。
  - `Move`: 最も近い敵に向かって移動する。
  - `Attack`: 敵にぶつかる。
- **ダメージ**: ポップアップ数値（ビルボードテキスト）はH&S感覚に不可欠。

### 2.2 データ構造 (Firestore)
- **ユニット**:
  - コンパクトなJSON（タイプID、レベル、装備ID）として保存する。
  - 永続化のために位置/回転を保存しない（リプレイが必要な場合のみ）。

## 3. コードスタイル (TypeScript)
- **Strict Mode**: 有効化。
- **コンポーネント**: フックを使用する関数コンポーネント。
- **状態管理**: Zustand（ゲーム状態に推奨）またはReact Context。
