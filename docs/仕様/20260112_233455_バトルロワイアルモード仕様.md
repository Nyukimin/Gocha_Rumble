# バトルロワイアルモード仕様

**作成日**: 2026-01-12  
**バージョン**: 1.0  
**ステータス**: 初版

---

## 1. 概要

元のゲーム案「PvPのバトルロワイアルで最後の一体まで順位をつける」を実現するモードです。

**目的**: 複数のプレイヤー（ゴースト）が同時に戦い、最後まで生き残った順位をつける

---

## 2. 基本コンセプト

### 2.1 モードの特徴

- **複数プレイヤー同時対戦**: 複数のゴーストチームが同時に戦場に出現
- **最後の一体まで順位決定**: 全ユニットが倒されるまで順位をつける
- **非同期PvP**: 各プレイヤーのチームデータを使ってシミュレーション
- **リアルタイム順位表示**: バトル中に順位がリアルタイムで更新される

### 2.2 通常のサバイバルモードとの違い

| 項目 | サバイバルモード | バトルロワイアルモード |
|------|----------------|---------------------|
| 敵の種類 | 通常敵・強化敵・ボス | 他のプレイヤーのゴーストチーム |
| 目標 | できるだけ長く生存 | 最後まで生き残る（順位を上げる） |
| 終了条件 | 全ユニットが倒される | 最後の1チームが残るまで |
| 報酬 | 生存時間・撃破数に応じた報酬 | 順位に応じた報酬 |

---

## 3. ゲームシステム詳細

### 3.1 参加プレイヤー数

- **参加人数**: 8-16人程度（調整可能）
- **マッチング**: 
  - ランダムマッチング（同程度の実力のプレイヤー同士）
  - または、友達同士でカスタムマッチング

### 3.2 バトル開始

- **セットアップ**: 通常モードと同様にチーム編成、装備、陣形を設定
- **マッチング**: 他のプレイヤーのゴーストチームを取得
- **配置**: 各チームは戦場の異なる位置に配置される

### 3.3 バトル進行

- **同時進行**: すべてのゴーストチームが同時に戦場で戦う
- **敵の認識**: 
  - 各チームは他のすべてのチームを「敵」として認識
  - 最も近い敵チームを優先的に攻撃
- **進化システム**: 通常モードと同様に、敵を倒すと進化ポイントが貯まり進化
- **ガチャシステム**: 通常モードと同様に、バトル中にガチャで装備を獲得

### 3.4 順位決定

- **順位の更新**: チームの全ユニットが倒された時点で順位が確定
- **最後の1チーム**: 最後まで生き残ったチームが1位
- **同順位**: 同時に全滅した場合は、生存時間が長い方が上位

### 3.5 リザルト

- **順位表示**: 最終順位を大きく表示
- **報酬**: 順位に応じた報酬（1位が最も高額）
- **統計情報**: 
  - 生存時間
  - 撃破したチーム数
  - 撃破したユニット数
  - 最終順位

---

## 4. 技術的実装

### 4.1 サーバー側演算方式

**重要**: バトルロワイアルモードは、サーバー側で演算を行い、クライアント側は再生のみです。

- **サーバー側でのシミュレーション**: 
  - サーバー側で一度だけバトルロワイアルのシミュレーションを実行
  - すべての参加チームのデータを使用して、決定論的にシミュレーション
  - シミュレーション結果（リプレイデータ）を生成

- **クライアント側での再生**:
  - サーバーからリプレイデータを受信
  - クライアント側では再生のみ（演算は行わない）
  - すべてのユーザーが同じリプレイを「見る」

- **ユーザー体験**:
  - ユーザーは自分のチームが参加していることを知っている
  - 同じリプレイを見ているが、「プレイしている感覚」になる
  - 自分のチームの動きを追いながら、他のチームとの戦いを見守る

### 4.2 サーバー側の実装

- **シミュレーションエンジン**: 
  - サーバー側でゲームロジックを実行
  - すべてのチームの行動を同時に計算
  - フレームごとの状態を記録（リプレイデータ）

- **リプレイデータの形式**:
  - フレームごとの全ユニットの位置・状態
  - イベント（進化、撃破、装備獲得など）
  - 順位の変化
  - データ量を最小化するため、差分形式で記録

- **配信**:
  - シミュレーション完了後、リプレイデータをすべての参加者に配信
  - または、リアルタイムストリーミング（サーバー側で計算しながら配信）

### 4.3 クライアント側の実装

- **リプレイ再生**:
  - サーバーから受信したリプレイデータを再生
  - 3Dシーンでユニットの動きを再現
  - カメラ操作は自由（自分のチームを追う、全体を見るなど）

- **パフォーマンス**:
  - **ユニット数**: 200体（全参加チームの合計）
  - **フレームレート**: 30FPS以上を維持
  - **最適化**: InstancedMeshを使用して効率的にレンダリング
  - 演算負荷が低いため、再生はスムーズ

### 4.4 マッチングシステム

- **実力マッチング**: 過去の戦績に基づいて、同程度の実力のプレイヤー同士をマッチング
- **待機時間**: マッチングが完了するまで待機（最大30秒程度）
- **フォールバック**: マッチングが完了しない場合は、AIチームで補完
- **マッチング完了後**: サーバー側でシミュレーションを開始

---

## 5. UI/UX設計

### 5.1 バトル画面

- **順位表示**: 画面右上に現在の順位を大きく表示
- **残りチーム数**: 「あと○チーム」という表示
- **各チームのHP状況**: 各ゴーストチームのHP状況を表示（オプション）
- **自分のチーム**: 自分のチームは色やマーカーで明確に識別

### 5.2 リザルト画面

- **順位表示**: 最終順位を大きく表示（1位の場合は特別な演出）
- **順位別報酬**: 順位に応じた報酬を表示
- **統計情報**: 詳細な統計情報を表示
- **再戦ボタン**: すぐに再戦できるボタン

---

## 6. 報酬システム

### 6.1 順位別報酬

- **1位**: 最高額の報酬（レアユニット、大量のコインなど）
- **2-3位**: 高額の報酬
- **4-8位**: 中程度の報酬
- **9位以下**: 基本報酬

### 6.2 追加報酬

- **撃破ボーナス**: 他のチームを撃破すると追加報酬
- **生存時間ボーナス**: 長く生存すると追加報酬
- **連勝ボーナス**: 連続で上位に入ると追加報酬

---

## 7. バランス調整

### 7.1 公平性の確保

- **同じ条件**: すべてのチームが同じ条件で戦う（敵の出現パターンなど）
- **ランダム要素**: ガチャや装備の出現はランダムだが、すべてのチームに同じ確率

### 7.2 実力差の調整

- **マッチング**: 同程度の実力のプレイヤー同士をマッチング
- **段階的な難易度**: 初心者向け、中級者向け、上級者向けのマッチング

---

## 8. 将来的な拡張

### 8.1 チーム戦モード

- 複数のプレイヤーがチームを組んで参加
- チーム内で協力して戦う

### 8.2 トーナメントモード

- 複数のラウンドを勝ち抜く
- 最終的に優勝者を決定

### 8.3 観戦モード

- 他のプレイヤーのバトルロワイアルを観戦
- 学習やエンターテイメントとして

---

## 9. 参照資料

- **製品仕様書**: `docs/仕様/20260112_224311_製品仕様書.md`
- **ユーザーリクエスト**: `docs/ユーザーのリクエスト.md`

---

## 10. 変更履歴

| 日付 | バージョン | 変更内容 | 変更者 |
|------|-----------|---------|--------|
| 2026-01-12 | 1.0 | 初版作成 | - |
